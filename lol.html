
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News & Ankündigungen</title>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #fff;
      --muted: #667;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color:#111;
      padding:20px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    h1 { font-size:20px; margin:0; font-weight:600; color:#0b2545; }

    .controls { display:flex; gap:8px; align-items:center; }

    button, .btn {
      background:#0b67ff; color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;
      box-shadow: 0 4px 10px rgba(11,103,255,0.12);
    }
    button.ghost { background:transparent; color:#0b67ff; box-shadow:none; border:1px solid rgba(11,103,255,0.12); }
    button.small { padding:6px 8px; font-size:13px; border-radius:6px; }

    /* Container */
    main { max-width:920px; margin:0 auto; }

    /* News list */
    #news-container { display:flex; flex-direction:column; gap:12px; margin-top:14px; }
    .news-item {
      display:flex; gap:12px; align-items:flex-start;
      background:var(--card); padding:12px; border-radius:12px;
      box-shadow: 0 6px 18px rgba(12,28,56,0.06);
      border-left:6px solid transparent; position:relative; overflow:hidden;
      transform: translateY(8px);
      opacity: 0;
      animation: slideIn 420ms forwards;
    }
    .news-item .icon { font-size:28px; color:#334; width:40px; text-align:center; margin-top:4px; }
    .news-body { flex:1; }
    .news-meta { color:var(--muted); font-size:13px; margin-top:6px; }
    .news-item:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(12,28,56,0.08); }

    .urgent { border:2px solid red !important; }

    @keyframes slideIn {
      to { transform: none; opacity:1; }
    }

    /* Popup */
    .popup {
      position: fixed; right:20px; top:20px; width:320px; z-index:20000;
      background:var(--card); padding:14px; border-radius:12px; box-shadow: 0 18px 40px rgba(12,28,56,0.18);
      display:flex; gap:10px; align-items:flex-start; opacity:0; transform:translateY(-12px) scale(.995);
      animation: popupIn 400ms forwards, popupOut 400ms forwards 4.5s;
    }
    .popup .icon { font-size:20px; margin-top:2px; }
    @keyframes popupIn { to { opacity:1; transform:none; } }
    @keyframes popupOut { to { opacity:0; transform:translateY(-12px) scale(.99); } }

    /* Modal (Settings) */
    .modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:20001;
      background: linear-gradient(rgba(7,10,25,0.45), rgba(7,10,25,0.45));
    }
    .modal.open { display:flex; }
    .modal-card {
      width:720px; max-width:95%; border-radius:12px; background:var(--card); padding:18px;
      box-shadow: 0 20px 60px rgba(2,6,23,0.4);
    }
    .modal-head { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .modal-body { display:flex; gap:20px; }
    .col { flex:1; min-width:0; }
    label.row { display:flex; gap:8px; align-items:center; margin:8px 0; font-size:14px; }

    input[type="text"], input[type="url"] {
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6e9ef;
      background: #fafbff;
    }
    .type-list { max-height:220px; overflow:auto; padding:6px; border-radius:8px; border:1px dashed #eef1f6; background:#fbfdff; }

    /* small helper styles */
    .muted { color:var(--muted); font-size:13px; }
    .note { font-size:13px; color:#445; margin-top:8px; }

    /* responsive */
    @media (max-width:640px){
      .modal-body { flex-direction:column; }
      header { flex-direction:column; align-items:flex-start; gap:10px; }
    }

  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>News &amp; Ankündigungen</h1>
        <div class="muted">Externer JSON-Feed | Popups &amp; Filter</div>
      </div>

      <div class="controls">
        <button onclick="openSettings()">⚙️ Einstellungen</button>
        <button class="ghost small" id="show-history-btn" style="display:none" onclick="openHistoryPanel()">Neueste Popups</button>
      </div>
    </header>

    <section id="news-container" aria-live="polite"></section>
  </main>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <div>
          <strong style="font-size:16px">Einstellungen</strong>
          <div class="muted">Konfiguriere Feed, Popups und Typ-Filter</div>
        </div>
        <div>
          <button class="ghost small" onclick="closeSettings()">Schließen</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="col">
          <label class="row">
            <input type="checkbox" id="toggle-popups">
            Popups anzeigen (dringende Meldungen werden immer gezeigt)
          </label>

          <div style="margin-top:10px">
            <label style="font-weight:600">Feed-URL (JSON)</label>
            <input id="feed-url" type="url" placeholder="https://example.com/news.json" />
            <div class="note">Die URL muss HTTPS liefern und CORS erlauben (<code>Access-Control-Allow-Origin</code>).</div>
          </div>

          <div style="margin-top:12px">
            <button onclick="saveSettings()" class="btn small">Speichern</button>
            <button onclick="resetSettings()" class="ghost small" style="margin-left:8px">Zurücksetzen</button>
          </div>
        </div>

        <div class="col" style="flex:0.9">
          <label style="font-weight:600">Nachrichten-Typen (ein/aus)</label>
          <div id="type-settings" class="type-list"></div>
          <div class="note">Dringende Nachrichten (<code>urgent</code>) umgehen die Filter.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup History Panel (simple overlay) -->
  <div id="history-modal" class="modal" role="dialog" aria-modal="true" style="display:none">
    <div class="modal-card" style="max-height:80vh; overflow:auto;">
      <div class="modal-head">
        <div><strong>Popup-Historie (nicht-angezeigte Popups)</strong><div class="muted" id="history-count"></div></div>
        <div><button class="ghost small" onclick="closeHistory()">Schließen</button></div>
      </div>
      <div id="history-list" style="display:flex;flex-direction:column;gap:10px"></div>
    </div>
  </div>

  <script>
  /***********************************************************************
   * Config / Defaults
   ***********************************************************************/
  const DEFAULT_FEED = "https://lg-newschannel.xo.je/news.json"; // <-- ändere das hier zuerst, oder in den Einstellungen
  const REFRESH_MS = 15000; // wie oft neu geladen wird (ms). Anpassen nach Bedarf.

  /***********************************************************************
   * State
   ***********************************************************************/
  let settings = {
    popups: true,
    feedUrl: DEFAULT_FEED,
    types: {} // { "news": true, "popup": true, ... }
  };

  let popupHistory = []; // gesammelte Popups, wenn Popups deaktiviert sind
  let lastNewsETag = null; // optional für ETag-based caching (nicht verwendet hier)
  let lastFetchTimestamp = 0;

  /***********************************************************************
   * Utilities
   ***********************************************************************/
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  function notifyConsole(msg){ console.log("[news] " + msg); }

  /***********************************************************************
   * Persistence
   ***********************************************************************/
  function loadLocalSettings(){
    try {
      const raw = localStorage.getItem("newsSettings_v1");
      if(raw){ settings = JSON.parse(raw); }
    } catch(e){ console.warn("Could not load settings:", e); }
    // Ensure fields exist
    if(typeof settings.popups !== "boolean") settings.popups = true;
    if(!settings.feedUrl) settings.feedUrl = DEFAULT_FEED;
    if(!settings.types) settings.types = {};
  }

  function saveLocalSettings(){
    localStorage.setItem("newsSettings_v1", JSON.stringify(settings));
  }

  /***********************************************************************
   * UI: Settings Modal
   ***********************************************************************/
  function openSettings(){
    qs("#settings-modal").classList.add("open");
    // fill controls
    qs("#toggle-popups").checked = !!settings.popups;
    qs("#feed-url").value = settings.feedUrl || "";
    // types will be filled after we fetch the feed
  }
  function closeSettings(){
    qs("#settings-modal").classList.remove("open");
  }
  function resetSettings(){
    if(confirm("Einstellungen auf Standard zurücksetzen?")){
      localStorage.removeItem("newsSettings_v1");
      settings = { popups:true, feedUrl: DEFAULT_FEED, types:{} };
      saveLocalSettings();
      closeSettings();
      loadAndRender(); // neu laden
    }
  }

  function saveSettings(){
    settings.popups = !!qs("#toggle-popups").checked;
    const inputs = qsa("#type-settings input[type=checkbox]");
    inputs.forEach(inp => {
      const t = inp.dataset.type;
      settings.types[t] = !!inp.checked;
    });
    const url = qs("#feed-url").value.trim();
    if(url) settings.feedUrl = url;
    saveLocalSettings();
    closeSettings();
    loadAndRender();
  }

  /***********************************************************************
   * Fetch & Render
   ***********************************************************************/
  async function fetchFeed(){
    const url = settings.feedUrl || DEFAULT_FEED;
    try {
      const res = await fetch(url, {cache: "no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      lastFetchTimestamp = Date.now();
      return json;
    } catch(err){
      console.error("Fehler beim Laden des Feeds:", err);
      return null;
    }
  }

  function clearNewsContainer(){
    const c = qs("#news-container");
    c.innerHTML = "";
  }

  function createNewsElement(item, idx){
    const wrapper = document.createElement("article");
    wrapper.className = "news-item";
    // urgent => red border (override)
    if(item.urgent) wrapper.classList.add("urgent");

    // left color from item.color (if present), else transparent
    if(item.color){
      try {
        wrapper.style.borderLeft = `6px solid ${item.color}`;
      } catch(e){ /* ignore */ }
    } else {
      wrapper.style.borderLeft = "6px solid transparent";
    }

    // inner markup
    const iconName = item.icon ? `bi bi-${item.icon}` : "bi bi-chat-left-text";
    wrapper.innerHTML = `
      <div class="icon"><i class="${iconName}"></i></div>
      <div class="news-body">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div style="font-weight:700">${escapeHtml(item.author || "System")}</div>
          <div class="muted" style="font-size:13px">${formatTimestamp(item.timestamp)}</div>
        </div>
        <div style="margin-top:6px">${escapeHtml(item.message)}</div>
        <div class="news-meta">${escapeHtml(item.type || "")} ${item.urgent ? " · DRINGEND" : ""}</div>
      </div>
    `;
    return wrapper;
  }

  function formatTimestamp(ts){
    if(!ts) return "";
    try{
      const d = new Date(ts);
      if(isNaN(d)) return ts;
      return d.toLocaleString();
    }catch(e){ return ts; }
  }

  function escapeHtml(s){
    if(!s && s !== 0) return "";
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'", "&#039;");
  }

  async function loadAndRender(){
    notifyConsole("Lade Feed von: " + settings.feedUrl);
    const data = await fetchFeed();
    if(!data){ showFeedError("Feed konnte nicht geladen werden. Prüfe die URL und CORS-Header."); return; }
    // expect data to be an array
    if(!Array.isArray(data)){ showFeedError("Erwartet JSON-Array. Deine Datei muss ein Array von Nachrichten enthalten."); return; }
    renderTypesFromFeed(data);
    renderNewsList(data);
  }

  function showFeedError(msg){
    const c = qs("#news-container");
    c.innerHTML = `<div style="padding:18px;background:#fff;border-radius:12px;border:1px solid #fee; color:#900">${escapeHtml(msg)}</div>`;
  }

  function renderTypesFromFeed(data){
    // collect unique types
    const types = Array.from(new Set(data.map(n => n.type || "news")));
    const container = qs("#type-settings");
    container.innerHTML = "";
    types.forEach(t => {
      if(!(t in settings.types)) settings.types[t] = true;
      const checked = settings.types[t] ? "checked" : "";
      const id = "type_" + t.replace(/\s+/g,"_");
      const label = document.createElement("label");
      label.className = "row";
      label.innerHTML = `<input type="checkbox" data-type="${t}" ${checked} /> <div style="font-weight:600">${escapeHtml(t)}</div>`;
      container.appendChild(label);
    });
    // also update the feed-url input (in case it was changed externally)
    qs("#feed-url").value = settings.feedUrl || "";
  }

  function renderNewsList(data){
    const container = qs("#news-container");
    container.innerHTML = "";

    // show only those items that pass the type filter or are urgent
    const filtered = data.filter(item => {
      const type = item.type || "news";
      if(item.urgent) return true;
      if(type in settings.types) return settings.types[type];
      return true;
    });

    // sort by timestamp if present (newest first)
    filtered.sort((a,b) => {
      const ta = a.timestamp ? Date.parse(a.timestamp) : 0;
      const tb = b.timestamp ? Date.parse(b.timestamp) : 0;
      return tb - ta;
    });

    // render items and handle popups
    filtered.forEach((item, idx) => {
      const el = createNewsElement(item, idx);
      container.appendChild(el);

      // handle popups
      if((item.type || "") === "popup"){
        if(settings.popups || item.urgent){
          // show live popup
          showPopup(item);
        } else {
          // store to history but do not show
          pushPopupHistory(item);
        }
      }
    });

    // hide or show history button
    qs("#show-history-btn").style.display = popupHistory.length > 0 ? "inline-block" : "none";
  }

  /***********************************************************************
   * Popup handling & History
   ***********************************************************************/
  function showPopup(item){
    const popup = document.createElement("div");
    popup.className = "popup";
    // left color stripe
    if(item.color){
      const stripe = document.createElement("div");
      stripe.style.width = "6px";
      stripe.style.height = "100%";
      stripe.style.position = "absolute";
      stripe.style.left = "0";
      stripe.style.top = "0";
      stripe.style.borderRadius = "12px 0 0 12px";
      stripe.style.background = item.color;
      popup.appendChild(stripe);
    }
    if(item.urgent) popup.style.border = "2px solid red";

    const iconName = item.icon ? `bi bi-${item.icon}` : "bi bi-bell";
    popup.innerHTML += `
      <div style="display:flex;gap:10px;align-items:flex-start;padding-left:8px">
        <div class="icon"><i class="${iconName}"></i></div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(item.author||"System")}</div>
          <div style="margin-top:6px">${escapeHtml(item.message)}</div>
          <div class="muted" style="margin-top:6px;font-size:12px">${formatTimestamp(item.timestamp)}</div>
        </div>
      </div>
    `;
    document.body.appendChild(popup);
    // remove after 5s (animation does fade out)
    setTimeout(()=>{ try{ popup.remove(); }catch(e){} }, 5200);
  }

  function pushPopupHistory(item){
    // avoid duplicates by id or identical content at top
    const marker = (item.id || (item.timestamp + "|" + item.message));
    if(popupHistory.length && (popupHistory[0].marker === marker)) return;
    popupHistory.unshift({ marker, item });
    if(popupHistory.length > 50) popupHistory.length = 50; // cap
    qs("#show-history-btn").style.display = "inline-block";
  }

  function openHistoryPanel(){
    const modal = qs("#history-modal");
    const list = qs("#history-list");
    list.innerHTML = "";
    popupHistory.forEach(rec => {
      const it = rec.item;
      const row = document.createElement("div");
      row.style.padding = "10px";
      row.style.borderRadius = "8px";
      row.style.background = "#fff";
      row.style.boxShadow = "0 6px 18px rgba(2,6,23,0.04)";
      row.innerHTML = `<div style="display:flex;gap:10px"><div style="font-weight:700">${escapeHtml(it.author||"System")}</div><div class="muted">${formatTimestamp(it.timestamp)}</div></div>
                       <div style="margin-top:6px">${escapeHtml(it.message)}</div>
                       <div class="muted" style="margin-top:6px">${escapeHtml(it.type||"popup")}${it.urgent? " · DRINGEND":""}</div>`;
      list.appendChild(row);
    });
    qs("#history-count").textContent = `${popupHistory.length} nicht-gezeigte Popups`;
    modal.style.display = "flex";
  }

  function closeHistory(){
    qs("#history-modal").style.display = "none";
  }

  /***********************************************************************
   * Init & Auto-refresh
   ***********************************************************************/
  loadLocalSettings();
  // initial load
  loadAndRender();

  // periodic refresh
  setInterval(() => {
    // rate-limit: don't fetch too often if last fetch is recent
    if(Date.now() - lastFetchTimestamp < Math.max(2000, REFRESH_MS/2)) return;
    loadAndRender();
  }, REFRESH_MS);

  // close settings/histories by clicking outside
  window.addEventListener("click", (ev) => {
    const modal = qs("#settings-modal");
    if(modal.classList.contains("open") && ev.target === modal) closeSettings();
    const hmodal = qs("#history-modal");
    if(hmodal.style.display === "flex" && ev.target === hmodal) closeHistory();
  });

  </script>
</body>
</html>